# Key Management Service (KMS)

KMS is a managed service used by other AWS services to encrypt data at rest. It is a regional public service.

- KMS can handle symmetric keys and asymmetric keys.
    - Symmetric keys and asymmetric keys are different in that symmetric keys use the same key for encryption and decryption while asymmetric keys use a public key for encryption and a private key for decryption.
- KMS keys never leave the product. It is provides FIPS 140-2 (Level 2) (the standard and level is an *exam point*)
- **KMS Keys** are logical containers for the physical keys. 
    - KMS Keys contain an ID, date, policy, description, and state.
    - KMS Keys are backed by a physical key material for encryption and decryption.
    - The physical key can be imported or generated.
    - KMS Keys can be used to encrypt or decrypt data up to 4KB in size. It is used only for small data or generating other keys.

## Architecture
- A user creates a KMS Key
- Encryption: A user makes an encrypt call to KMS specifying the KMS Key to use and the data to encrypt.
    - If the user is authorized to use the KMS Key for encryption, KMS will will decrypt the key material and uses it to encrypt the data.
    - KMS returns the encrypted data to the user.
- Decryption: A user makes a decrypt call to KMS and provide the data to decrypt. The user does not need to provide the KMS Key because the data will include ciphertext indicating which KMS Key was used.
    - If the user is authorized to use the KMS Key for decryption, KMS will will decrypt the key material and uses it to decrypt the data.
    - KMS returns the decrypted data to the user.

## Permissions
**Role separation** governs who can use a KMS Key and for what operations. Creating, encrypting, and decrypting are different operations that an individual needs authorization for.

- KMS permissions are handled by a **key policy** which is a policy. Every key has a key policy.
- KMS is different from other services where granting access to an identity allows the identity to use the resource unless there is an explcit deny. 
- In KMS, account trust must be explicitly added on the key policy (*exam point*). If the key policy does not trust the account, the identity will not be able to use the key even if the identity has permission to use the key.
- Generally, a (1) key policy is used to trust an account and (2) an identity policy is then used to allow IAM Users to use the key. In higher security environments, account trust might be removed and the actions might be specifically included in the key policy instead.
- Key policies are regional unlike IAM policies which are global.

## Data Encryption Keys (DEKs)
For large data, KMS uses **Data Encryption Keys (DEKs)**.
- DEKs are generated by KMS through the **GenerateDataKey** API.
- DEKs are stored by the user and not stored by KMS.
- KMS does not use the DEK to encrypt or decrypt data. It only provides the DEK.

**DEK Usage**
- A user will generate a DEK using a KMS Key through the **GenerateDataKey** API. KMS will return the plaintext DEK and the ciphertext DEK which uses the KMS Key to encrypt the plaintext DEK.
- The user will use the plaintext DEK to encrypt the data.
- The user will store the ciphertext DEK in a database or other storage.
- When the user needs to decrypt the data, the user will provide the ciphertext (encrypted DEK) to KMS. KMS will decrypt the ciphertext using the KMS Key used to generate the DEK and return the plaintext DEK. 
- You can use the plaintext DEK to decrypt the data and discard it after use.

## Key Management
- Keys are either **customer managed keys** or **AWS managed keys**. AWS managed keys are generated by services such as Amazon S3 and Amazon RDS.
- Customer managed keys are more configurable and allow modifying key policies to allow feature such as cross-account access. 
- Both keys support **key rotation**. Key rotation cannot be disabled for AWS managed keys and occurs approximate every year. Customer managed keys rotation is optional.
- A KMS key contains the **backing key** which is the physical key material and previous backing keys.
    - Aliases can be used to reference a KMS Key to allow for keys to be changed without changing the alias.
    - Aliases are at a region level.
